<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡ç½‘ç«™åº”ç”¨ç™»å½•ç¤ºä¾‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨è‡ªå®šä¹‰ CSS ç¡®ä¿èƒŒæ™¯å’Œå­—ä½“ç¾è§‚ */
        body {
            background-color: #f7f9fb;
            font-family: 'Inter', sans-serif;
        }
        /* æ¨¡æ‹Ÿå¾®ä¿¡ç™»å½•æ¡†çš„æ ·å¼ */
        .wechat-login-box {
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
        }
        /* ç¡®ä¿äºŒç»´ç å®¹å™¨å±…ä¸­ */
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 250px;
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: #e5e7eb; /* Placeholder background */
            border-radius: 8px;
            font-size: 0.875rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="wechat-login-box w-full max-w-sm">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">æ¬¢è¿ç™»å½•æ‚¨çš„åº”ç”¨</h1>
        <p class="text-sm text-gray-500 mb-6">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æˆæƒ</p>
        
        <!-- é…ç½®æç¤ºï¼ˆå¦‚æœæœªé…ç½®ï¼‰ -->
        <div id="config-hint" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-left">
            <p class="text-xs text-yellow-800 font-semibold mb-1">ğŸ“ é…ç½®æç¤º</p>
            <p class="text-xs text-yellow-700">è¯·åœ¨é¡µé¢åŠ è½½å‰è®¾ç½®ï¼š</p>
            <code class="text-xs bg-yellow-100 px-2 py-1 rounded block mt-1">window.__wechat_appid = 'ä½ çš„AppID'</code>
        </div>
        
        <!-- 
            è¿™æ˜¯åµŒå…¥å¾®ä¿¡ç™»å½•äºŒç»´ç çš„æ ¸å¿ƒå®¹å™¨ã€‚
            å¾®ä¿¡çš„ JS è„šæœ¬å°†åœ¨è¿™ä¸ª ID ä¸º 'qrcode-container' çš„å…ƒç´ å†…ç”Ÿæˆ QR ç ã€‚
        -->
        <div id="qrcode-container" class="transition duration-300">
            <!-- å®é™…çš„ QR ç å°†é€šè¿‡ JavaScript æ³¨å…¥åˆ°è¿™é‡Œ -->
            <p class="text-gray-500">æ­£åœ¨åŠ è½½äºŒç»´ç ...</p>
        </div>

        <p class="text-xs text-gray-400 mt-4">
            æ‰«ææˆåŠŸåï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤æˆæƒã€‚
        </p>
        
        <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘æ—¶å¯è§ï¼‰ -->
        <div id="debug-info" class="hidden mt-4 p-2 bg-gray-50 rounded text-left text-xs">
            <p class="font-semibold mb-1">è°ƒè¯•ä¿¡æ¯ï¼š</p>
            <pre id="debug-content" class="text-xs overflow-auto"></pre>
        </div>
    </div>

    <!-- å¾®ä¿¡å®˜æ–¹ç™»å½• JS SDK -->
    <script src="https://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js"></script>
    
    <script>
        // ===== é…ç½®åŒºåŸŸ =====
        // è¯·æ›¿æ¢ä¸ºä½ çš„å¾®ä¿¡å¼€æ”¾å¹³å°åº”ç”¨é…ç½®
        const WECHAT_CONFIG = {
            appid: typeof __wechat_appid !== 'undefined' ? __wechat_appid : 'wxfa0de745b8004742',  // å¾®ä¿¡å¼€æ”¾å¹³å° AppID
            redirect_uri: typeof __wechat_redirect_uri !== 'undefined' ? __wechat_redirect_uri : encodeURIComponent(window.location.origin + '/callback.html'),  // æˆæƒå›è°ƒåœ°å€ï¼ˆéœ€è¦ URL ç¼–ç ï¼‰
            state: 'test_state_' + Date.now(),  // è‡ªå®šä¹‰çŠ¶æ€å‚æ•°
            style: 'black'  // äºŒç»´ç æ ·å¼ï¼š'black' æˆ– 'white'
        };
        // ====================

        function initWeChatLogin() {
            const container = document.getElementById('qrcode-container');
            const configHint = document.getElementById('config-hint');
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            // æ£€æŸ¥é…ç½®
            if (!WECHAT_CONFIG.appid || WECHAT_CONFIG.appid === 'YOUR_WECHAT_APPID') {
                configHint.classList.remove('hidden');
                container.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-red-600 font-semibold mb-2">âš ï¸ é…ç½®é”™è¯¯</p>
                        <p class="text-sm text-gray-600 mb-2">è¯·å…ˆé…ç½®å¾®ä¿¡ AppID</p>
                        <p class="text-xs text-gray-500">åœ¨ä»£ç ä¸­è®¾ç½® <code class="bg-gray-200 px-1 rounded">WECHAT_CONFIG.appid</code></p>
                        <p class="text-xs text-gray-500 mt-2">æˆ–åœ¨é¡µé¢åŠ è½½å‰è®¾ç½®ï¼š<code class="bg-gray-200 px-1 rounded">window.__wechat_appid = 'ä½ çš„AppID'</code></p>
                    </div>
                `;
                return;
            } else {
                configHint.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                debugInfo.classList.remove('hidden');
                debugContent.textContent = JSON.stringify({
                    appid: WECHAT_CONFIG.appid,
                    redirect_uri: decodeURIComponent(WECHAT_CONFIG.redirect_uri),
                    state: WECHAT_CONFIG.state,
                    wxLogin_loaded: typeof WxLogin !== 'undefined'
                }, null, 2);
            }

            // æ£€æŸ¥ wxLogin.js æ˜¯å¦åŠ è½½å®Œæˆ
            if (typeof WxLogin === 'undefined') {
                container.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-yellow-600 font-semibold mb-2">â³ æ­£åœ¨åŠ è½½å¾®ä¿¡ç™»å½•ç»„ä»¶...</p>
                        <p class="text-xs text-gray-500">å¦‚æœé•¿æ—¶é—´æœªæ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                    </div>
                `;
                
                // ç­‰å¾… wxLogin.js åŠ è½½ï¼ˆæœ€å¤šç­‰å¾… 5 ç§’ï¼‰
                let waitCount = 0;
                const checkInterval = setInterval(() => {
                    waitCount++;
                    if (typeof WxLogin !== 'undefined') {
                        clearInterval(checkInterval);
                        initWeChatLogin(); // é‡æ–°åˆå§‹åŒ–
                    } else if (waitCount > 50) { // 5ç§’åè¶…æ—¶
                        clearInterval(checkInterval);
                        container.innerHTML = `
                            <div class="p-4 text-center">
                                <p class="text-red-600 font-semibold mb-2">âŒ åŠ è½½å¤±è´¥</p>
                                <p class="text-sm text-gray-600">æ— æ³•åŠ è½½å¾®ä¿¡ç™»å½•ç»„ä»¶</p>
                                <p class="text-xs text-gray-500 mt-2">è¯·æ£€æŸ¥ <code class="bg-gray-200 px-1 rounded">wxLogin.js</code> æ˜¯å¦æ­£ç¡®å¼•å…¥</p>
                            </div>
                        `;
                    }
                }, 100);
                return;
            }

            // æ¸…ç©ºå®¹å™¨å†…å®¹
            container.innerHTML = '';
            container.style.backgroundColor = 'transparent';

            try {
                // åˆå§‹åŒ–å¾®ä¿¡ç™»å½•ç»„ä»¶
                const wxLogin = new WxLogin({
                    self_redirect: false,           // false: åœ¨ iframe ä¸­æ˜¾ç¤ºäºŒç»´ç ï¼Œtrue: ç›´æ¥è·³è½¬
                    id: "qrcode-container",         // å®¹å™¨ ID
                    appid: WECHAT_CONFIG.appid,     // å¾®ä¿¡å¼€æ”¾å¹³å° AppID
                    scope: "snsapi_login",          // æˆæƒèŒƒå›´ï¼šsnsapi_loginï¼ˆç½‘ç«™åº”ç”¨ç™»å½•ï¼‰
                    redirect_uri: WECHAT_CONFIG.redirect_uri,  // æˆæƒåå›è°ƒåœ°å€ï¼ˆå¿…é¡» URL ç¼–ç ï¼‰
                    state: WECHAT_CONFIG.state,     // è‡ªå®šä¹‰çŠ¶æ€å‚æ•°ï¼ˆç”¨äºé˜²æ­¢ CSRFï¼‰
                    style: WECHAT_CONFIG.style,     // äºŒç»´ç æ ·å¼
                    href: ""                        // è‡ªå®šä¹‰ CSS æ–‡ä»¶ URLï¼ˆå¯é€‰ï¼‰
                });
                
                console.log("âœ… å¾®ä¿¡ç™»å½•ç»„ä»¶åˆå§‹åŒ–æˆåŠŸ");
                console.log("é…ç½®ä¿¡æ¯:", WECHAT_CONFIG);
                
            } catch (error) {
                console.error("âŒ å¾®ä¿¡ç™»å½•ç»„ä»¶åˆå§‹åŒ–å¤±è´¥:", error);
                container.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-red-600 font-semibold mb-2">âŒ åˆå§‹åŒ–å¤±è´¥</p>
                        <p class="text-sm text-gray-600">${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                        <p class="text-xs text-gray-500 mt-2">è¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '<p class="text-gray-500">æ­£åœ¨åˆå§‹åŒ–...</p>';
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ DOM å®Œå…¨åŠ è½½ï¼Œç„¶ååˆå§‹åŒ–
            setTimeout(initWeChatLogin, 100);
        });

        // å¦‚æœ DOM å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(initWeChatLogin, 100);
        }
    </script>
</body>
</html>